{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const actionBtn = document.querySelector("button[name='index']");
    const confirmBtn = document.getElementById("confirmtechnique");
    const cancelBtn = document.getElementById("canceltechnique");
    const modal = document.getElementById("stainingTechniqueModal");
    const overlay = document.getElementById("modalOverlay");
    let selectedIds = [];
    actionBtn.addEventListener("click", function (e) {
       const actionSelect = document.querySelector("select[name='action']");
       if (actionSelect && actionSelect.value === "send_to_staining_old") {
           const checkboxes = document.querySelectorAll("input.action-select:checked");
           if (checkboxes.length > 0) {
                e.preventDefault();
                selectedIds = Array.from(checkboxes).map(cb => cb.value);
                const inputURL = `${window.location.origin}/configuration/ajax/get_staining_techniques/`;
                $.ajax({
                    url: inputURL,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        const select = document.getElementById("selectstainingtechnique");
                        select.innerHTML = "";

                        if (!data.staining_techniques || data.staining_techniques.length === 0) {
                            alert("No staining techniques available.");
                            return;
                        }

                        const optSelect = document.createElement("option");
                        optSelect.value = '';
                        optSelect.textContent = 'Select';
                        select.appendChild(optSelect);

                        data.staining_techniques.forEach(item => {
                            const opt = document.createElement("option");
                            opt.value = item.value;
                            opt.textContent = item.display_value;
                            select.appendChild(opt);
                        });

                        document.getElementById("stainingTechniqueModal").style.display = "block";
                        document.getElementById("modalOverlay").style.display = "block";

                    },
                    error: function (error) {
                        console.error('Error fetching Staining Techniques:', error);
                    }
                });
           }
       }
    });
    cancelBtn.addEventListener("click", function () {
        document.getElementById("stainingTechniqueModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
    });
    confirmBtn.addEventListener("click", function () {
        const selectedTechnique = document.getElementById("selectstainingtechnique").value;

        if (!selectedTechnique) {
            alert("Please select a Staining Technique");
            return;
        }

        // Add hidden input so Django action can receive it
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "staining_technique";
        hidden.value = selectedTechnique;

        const actionForm = document.getElementById("changelist-form");
        actionForm.appendChild(hidden);

        // Hide modal
        document.getElementById("stainingTechniqueModal").style.display = "none";

        // Submit the form now
        actionForm.submit();

    });
});
</script>

{% endblock %}

{% block content %}
{{ block.super }}

{# Modal for selecting staining technique #}
<div id="stainingTechniqueModal"
     style="display: none; background: #fff; border: 1px solid #ccc; padding: 20px; position: fixed; top: 30%; left: 40%; z-index: 1000;width: 30vw;height: 30vh">
    <h3 style="background-color: blue; color: white; padding: 5px;">Select Staining Technique</h3>
    <select id="selectstainingtechnique" style="width: 100%; padding: 5px; margin-bottom: 10px;"></select>
    <button id="confirmtechnique" class="button btn-primary">Confirm</button>
    <button id="canceltechnique" class="button btn-primary">Cancel</button>
</div>
<div id="modalOverlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    "></div>
{% endblock %}
