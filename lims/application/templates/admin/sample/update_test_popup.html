{% extends base_template %}
{% load static %}

{% block content %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 20px;
    }

    h2 {
        text-align: center !important;
        display: block;
        width: 100%;
        margin-top: 0px;
        margin-bottom: 20px;
    }

    form {
        max-width: 800px; /* Adjusted slightly smaller since this table is simpler */
        margin-left: auto !important;
        margin-right: auto !important;
        box-sizing: border-box;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
        margin-bottom: 20px;
        box-sizing: border-box;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    select {
        width: 100%;
        padding: 6px;
        box-sizing: border-box;
    }

    /* Button Container */
    .button-row {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        color: white;
    }

    button[type="submit"] {
        background-color: #007bff;
    }

    button[type="submit"]:hover {
        background-color: #0056b3;
    }

    button#close-popup-btn {
        background-color: #6c757d; /* Gray for secondary action */
    }

    button#close-popup-btn:hover {
        background-color: #5a6268;
    }
</style>

<h2>Update Test Selection</h2>

<form method="post" action="{% url 'controllerapp:ihcworkflow_ihcworkflow_update_test_submit' %}">
  {% csrf_token %}
  <input type="hidden" name="ids" value="{{ ids }}">
  <input type="hidden" name="q" value="{{ accession_filter }}">

  <table>
    <thead>
      <tr>
        <th style="min-width: 200px;">Sample ID</th>
        <th style="min-width: 300px;">Test</th>
      </tr>
    </thead>
    <tbody>
      {% for row in sample_rows %}
        <tr>
          <td>{{ row.sample.sample_id }}</td>
          <td>
            <select name="test_{{ row.sample.sample_id }}">
              {% for test in row.tests %}
                <option value="{{ test.pk }}" {% if row.existing_test_id == test.pk %}selected{% endif %}>{{ test.test_name }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="button-row">
    <button type="submit">Update (Ctrl+Enter)</button>
    <button type="button" id="close-popup-btn">Close</button>
  </div>
</form>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function() {
      const firstDropdown = document.querySelector('select');
      if (firstDropdown) {
          firstDropdown.focus();
      }
  });

  document.getElementById("close-popup-btn").onclick = function() {
    if(window.opener) {
      // Refresh parent page with applied filters
      const url = "{{ redirect_url }}";
      window.opener.location.href = url;
    }
    window.close();
  }

  document.addEventListener("keydown", function(e) {
      if (e.ctrlKey && e.key === "Enter") {
          const updateBtn = document.querySelector("button[type='submit']");
          if (updateBtn) {
              updateBtn.click();
          } else {
              console.error("Update button not found!");
          }
      }
  });
</script>
{% endblock %}